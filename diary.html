<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 귀여운 일기장 🐸🐱</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* 전반적인 분위기: 귀엽고 따뜻한 느낌, 파스텔 톤 색상 */
        body {
            font-family: 'Inter', sans-serif; /* 기본 폰트 설정 */
            background-color: #f7f2e9; /* 연한 베이지색 배경 */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* 상단 정렬 */
            min-height: 100vh;
            box-sizing: border-box;
            color: #5a4a42; /* 부드러운 갈색 텍스트 */
        }

        .container {
            background-color: #ffffff; /* 흰색 컨테이너 배경 */
            border-radius: 25px; /* 둥근 모서리 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* 부드러운 그림자 */
            padding: 30px;
            max-width: 700px; /* 최대 너비 설정 */
            width: 100%; /* 모바일에서 전체 너비 사용 */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px; /* 섹션 간 간격 */
            margin-top: 20px; /* 상단 여백 */
        }

        /* 헤더 스타일링 */
        .header {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #ff9a8d; /* 따뜻한 주황색 제목 */
            font-size: 2.5em;
            margin: 0;
            font-weight: 600;
        }

        /* 각 섹션 공통 스타일 */
        .section {
            background-color: #fcf8f3; /* 연한 배경색 */
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05); /* 은은한 내부 그림자 */
        }

        .section h2 {
            color: #a8d5ba; /* 민트색 제목 */
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 2px solid #e0f2e8;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* 날짜 선택 및 표시 */
        .date-selection input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0f2e8; /* 연한 민트색 테두리 */
            border-radius: 10px;
            font-size: 1em;
            color: #5a4a42;
            box-sizing: border-box;
            background-color: #ffffff;
        }

        /* 일기 작성 영역 */
        .diary-entry textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0f2e8;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            color: #5a4a42;
            resize: vertical; /* 세로 크기 조절 가능 */
            box-sizing: border-box;
            background-color: #ffffff;
        }

        /* 감정/태그 선택 */
        .emotion-tags .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emotion-tags .option {
            padding: 10px 15px;
            border-radius: 20px;
            background-color: #ffe0b2; /* 연한 주황색 배경 */
            color: #a0522d; /* 진한 주황색 텍스트 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            white-space: nowrap; /* 텍스트가 줄바꿈되지 않도록 */
        }

        .emotion-tags .option:hover {
            background-color: #ffd180;
            transform: translateY(-2px);
        }

        .emotion-tags .option.selected {
            background-color: #ff9a8d; /* 선택 시 더 진한 색 */
            color: #ffffff;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        /* 사진 첨부 */
        .photo-attachment input[type="file"] {
            display: none; /* 기본 파일 입력 숨기기 */
        }

        .photo-attachment .custom-file-upload {
            display: inline-block;
            padding: 10px 20px;
            background-color: #a8d5ba; /* 민트색 버튼 */
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
            margin-bottom: 15px; /* 파일 업로드 버튼 아래 여백 */
        }

        .photo-attachment .custom-file-upload:hover {
            background-color: #8ecaa1;
        }

        /* 여러 이미지 미리보기 컨테이너 */
        #imagePreviewsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        /* 이미지 미리보기 개별 아이템 */
        .image-preview-item {
            position: relative;
            max-width: 100px;
            max-height: 100px;
            border-radius: 10px;
            border: 2px dashed #e0f2e8;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-preview-item:hover {
            transform: scale(1.05);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px; /* 부모의 둥근 모서리에 맞춤 */
        }

        /* 이미지 삭제 버튼 */
        .image-delete-button {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff7f7f;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease;
        }

        .image-delete-button:hover {
            background-color: #ff6363;
        }


        /* 버튼 그룹 */
        .button-group {
            display: flex;
            flex-wrap: wrap; /* 모바일에서 줄바꿈 */
            gap: 15px;
            justify-content: center;
        }

        .button-group button {
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .button-group button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .button-group #saveButton {
            background-color: #ffbe76; /* 연한 주황색 */
        }
        .button-group #saveButton:hover {
            background-color: #ffa54f;
        }

        .button-group #editButton {
            background-color: #a8d5ba; /* 민트색 */
        }
        .button-group #editButton:hover {
            background-color: #8ecaa1;
        }

        .button-group #deleteButton {
            background-color: #ff7f7f; /* 연한 빨강색 */
        }
        .button-group #deleteButton:hover {
            background-color: #ff6363;
        }

        /* 일기 목록/달력 (간단한 목록 형태로 구현) */
        .diary-list ul {
            list-style: none;
            padding: 0;
        }

        .diary-list li {
            background-color: #fffacd; /* 연한 노랑색 */
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .diary-list li:hover {
            background-color: #fff8dc;
        }

        .diary-list li span {
            font-weight: 600;
            color: #a0522d;
        }

        .diary-list li button {
            background-color: #ff9a8d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .diary-list li button:hover {
            background-color: #ff7f7f;
        }

        /* 검색 기능 */
        .search-diary {
            display: flex;
            gap: 10px;
        }

        .search-diary input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid #e0f2e8;
            border-radius: 10px;
            font-size: 1em;
            color: #5a4a42;
            box-sizing: border-box;
            background-color: #ffffff;
        }

        .search-diary button {
            padding: 12px 20px;
            background-color: #ffbe76;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .search-diary button:hover {
            background-color: #ffa54f;
        }

        #searchResults {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #e0f2e8;
        }

        #searchResults div {
            background-color: #fcf8f3;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #5a4a42;
        }

        /* 백업 기능 */
        .backup-diary .date-range {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* 모바일에서 줄바꿈 */
        }

        .backup-diary .date-range input[type="date"] {
            flex: 1;
            min-width: 120px; /* 최소 너비 설정 */
            padding: 12px;
            border: 2px solid #e0f2e8;
            border-radius: 10px;
            font-size: 1em;
            color: #5a4a42;
            box-sizing: border-box;
            background-color: #ffffff;
        }

        .backup-diary button {
            width: 100%;
            padding: 12px 20px;
            background-color: #76baff; /* 파란색 백업 버튼 */
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .backup-diary button:hover {
            background-color: #5a9ce0;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* 이미지 확대 모달 */
        .image-modal {
            display: none; /* 기본적으로 숨김 */
            position: fixed;
            z-index: 1002; /* 다른 요소 위에 표시 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); /* 반투명 검정 배경 */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain; /* 이미지 비율 유지 */
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }


        /* 모바일 반응형 디자인 */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                margin-top: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .button-group button {
                width: 100%; /* 버튼 너비 100% */
                padding: 15px;
            }

            /* "오늘의 기분 & 태그" 버튼 크기 개선 */
            .emotion-tags .options {
                flex-direction: row; /* 세로 정렬 대신 가로 정렬 유지 */
                flex-wrap: wrap; /* 내용에 따라 줄바꿈 */
                justify-content: center; /* 중앙 정렬 */
                align-items: center;
            }

            .emotion-tags .option {
                flex-shrink: 0; /* 줄어들지 않도록 방지 */
            }

            .search-diary {
                flex-direction: column;
            }

            .search-diary button {
                width: 100%;
            }

            .backup-diary .date-range {
                flex-direction: column; /* 백업 날짜 선택 세로 정렬 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🐸 나의 소중한 일기 🐱</h1>
        </header>

        <section class="section date-selection">
            <h2>오늘의 날짜</h2>
            <input type="date" id="diaryDate">
        </section>

        <section class="section emotion-tags">
            <h2>오늘의 기분 & 태그</h2>
            <div class="options">
                <span class="option" data-value="happy">😊 행복</span>
                <span class="option" data-value="sad">😢 슬픔</span>
                <span class="option" data-value="angry">😡 화남</span>
                <span class="option" data-value="excited">🤩 신남</span>
                <span class="option" data-value="tired">😴 피곤</span>
                <span class="option" data-value="love">💖 사랑</span>
                <span class="option" data-value="daily">#일상</span>
                <span class="option" data-value="study">#공부</span>
                <span class="option" data-value="travel">#여행</span>
                <span class="option" data-value="food">#음식</span>
            </div>
            <input type="hidden" id="selectedEmotion">
            <input type="hidden" id="selectedTags">
        </section>

        <section class="section diary-entry">
            <h2>오늘의 이야기</h2>
            <textarea id="diaryContent" placeholder="오늘 하루는 어땠나요? 자유롭게 기록해보세요..."></textarea>
        </section>

        <section class="section photo-attachment">
            <h2>사진 첨부</h2>
            <label for="photoUpload" class="custom-file-upload">사진 선택</label>
            <input type="file" id="photoUpload" accept="image/*" multiple>
            <div id="imagePreviewsContainer">
                </div>
        </section>

        <div class="button-group">
            <button id="saveButton">저장 💾</button>
            <button id="editButton">수정 ✏️</button>
            <button id="deleteButton">삭제 🗑️</button>
        </div>

        <section class="section diary-list">
            <h2>내 일기 목록</h2>
            <ul id="diaryList">
                <li>아직 작성된 일기가 없어요.</li>
            </ul>
        </section>

        <section class="section search-diary">
            <h2>일기 검색</h2>
            <input type="text" id="searchQuery" placeholder="검색할 내용을 입력하세요...">
            <button id="searchButton">검색 🔍</button>
            <div id="searchResults">
                </div>
        </section>

        <section class="section backup-diary">
            <h2>일기 백업</h2>
            <div class="date-range">
                <input type="date" id="backupStartDate">
                <span>~</span>
                <input type="date" id="backupEndDate">
            </div>
            <button id="backupButton">백업 📥</button>
        </section>
    </div>

    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script>
        // DOM 요소 가져오기
        const diaryDateInput = document.getElementById('diaryDate');
        const diaryContentTextarea = document.getElementById('diaryContent');
        const saveButton = document.getElementById('saveButton');
        const editButton = document.getElementById('editButton');
        const deleteButton = document.getElementById('deleteButton');
        const photoUploadInput = document.getElementById('photoUpload');
        const imagePreviewsContainer = document.getElementById('imagePreviewsContainer'); // 여러 이미지 미리보기 컨테이너
        const emotionOptions = document.querySelectorAll('.emotion-tags .option');
        const selectedEmotionInput = document.getElementById('selectedEmotion');
        const selectedTagsInput = document.getElementById('selectedTags');
        const diaryListUl = document.getElementById('diaryList');
        const searchQueryInput = document.getElementById('searchQuery');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');

        // 백업 관련 DOM 요소
        const backupStartDateInput = document.getElementById('backupStartDate');
        const backupEndDateInput = document.getElementById('backupEndDate');
        const backupButton = document.getElementById('backupButton');

        // 이미지 모달 관련 DOM 요소
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const imageModalClose = document.getElementsByClassName('image-modal-close')[0];


        // 초기화: 오늘 날짜 설정 및 해당 날짜 일기 불러오기
        window.onload = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            diaryDateInput.value = todayString;
            backupStartDateInput.value = todayString; // 백업 시작 날짜도 오늘로 초기화
            backupEndDateInput.value = todayString;   // 백업 종료 날짜도 오늘로 초기화
            loadDiary(todayString);
            renderDiaryList();
        };

        // 날짜 변경 시 해당 날짜의 일기 불러오기
        diaryDateInput.addEventListener('change', (event) => {
            const selectedDate = event.target.value;
            loadDiary(selectedDate);
        });

        // 감정/태그 선택 핸들러
        emotionOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.dataset.value;
                // 감정은 단일 선택, 태그는 다중 선택
                const isEmotion = ['happy', 'sad', 'angry', 'excited', 'tired', 'love'].includes(value);

                if (isEmotion) {
                    // 감정은 단일 선택
                    emotionOptions.forEach(opt => {
                        const optValue = opt.dataset.value;
                        const optIsEmotion = ['happy', 'sad', 'angry', 'excited', 'tired', 'love'].includes(optValue);
                        if (optIsEmotion) {
                            opt.classList.remove('selected');
                        }
                    });
                    option.classList.add('selected');
                    selectedEmotionInput.value = value;
                } else {
                    // 태그는 다중 선택 가능
                    option.classList.toggle('selected');
                    const selectedTags = Array.from(document.querySelectorAll('.emotion-tags .option.selected'))
                                            .filter(opt => !['happy', 'sad', 'angry', 'excited', 'tired', 'love'].includes(opt.dataset.value))
                                            .map(opt => opt.dataset.value);
                    selectedTagsInput.value = JSON.stringify(selectedTags);
                }
            });
        });

        // 사진 첨부 미리보기 기능 (여러 장)
        photoUploadInput.addEventListener('change', (event) => {
            // 기존 미리보기는 유지하고 새 파일만 추가
            const files = event.target.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        createImagePreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            }
            photoUploadInput.value = ''; // 같은 파일 다시 선택할 수 있도록 입력 초기화
        });

        // 이미지 미리보기 생성 및 삭제/모달 기능 추가 함수
        function createImagePreview(imgSrc) {
            const imagePreviewItem = document.createElement('div');
            imagePreviewItem.classList.add('image-preview-item');

            const img = document.createElement('img');
            img.src = imgSrc;
            img.alt = '선택된 이미지 미리보기';
            imagePreviewItem.appendChild(img);

            const deleteButton = document.createElement('span');
            deleteButton.classList.add('image-delete-button');
            deleteButton.textContent = 'x';
            deleteButton.title = '사진 삭제';
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); // 이미지 클릭 이벤트 방지
                imagePreviewItem.remove(); // 미리보기 아이템 삭제
            });
            imagePreviewItem.appendChild(deleteButton);

            // 이미지 클릭 시 모달 열기 이벤트 리스너 추가
            img.addEventListener('click', () => {
                modalImage.src = img.src;
                imageModal.style.display = 'flex'; // flex로 설정하여 중앙 정렬
            });

            imagePreviewsContainer.appendChild(imagePreviewItem);
        }


        // 이미지 모달 닫기 이벤트
        imageModalClose.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        // 모달 외부 클릭 시 닫기 (옵션)
        imageModal.addEventListener('click', (event) => {
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });


        // 저장 버튼 클릭 이벤트
        saveButton.addEventListener('click', () => {
            const date = diaryDateInput.value;
            const content = diaryContentTextarea.value;
            const emotion = selectedEmotionInput.value;
            const tags = JSON.parse(selectedTagsInput.value || '[]');
            
            // 현재 표시된 여러 이미지 데이터 수집
            const imageDataArray = [];
            Array.from(imagePreviewsContainer.querySelectorAll('.image-preview-item img')).forEach(img => {
                if (img.src && img.src !== '#') {
                    imageDataArray.push(img.src);
                }
            });

            if (!date || !content) {
                alertMessage('날짜와 내용을 입력해주세요!', 'warning');
                return;
            }

            const diaryEntry = {
                content: content,
                emotion: emotion,
                tags: tags,
                imageData: imageDataArray, // 이미지 데이터를 배열로 저장
                timestamp: new Date().toISOString() // 저장 시 타임스탬프
            };

            // 로컬 저장 로직
            saveDiaryLocally(date, diaryEntry);
            alertMessage('일기가 성공적으로 저장되었습니다!', 'success');
            renderDiaryList(); // 목록 업데이트
            clearDiaryForm(); // 저장 후 폼 초기화
            // 서버 저장 (개념적)
            // saveDiaryToServer(date, diaryEntry);
        });

        // 수정 버튼 클릭 이벤트 (현재 날짜의 일기 불러오기)
        editButton.addEventListener('click', () => {
            const date = diaryDateInput.value;
            loadDiary(date);
            alertMessage('현재 날짜의 일기를 불러왔습니다. 수정 후 다시 저장해주세요.', 'info');
        });

        // 삭제 버튼 클릭 이벤트
        deleteButton.addEventListener('click', async () => { // async 추가
            const date = diaryDateInput.value;
            const confirmed = await confirmMessage('정말로 이 날짜의 일기를 삭제하시겠습니까?'); // await 추가
            if (confirmed) {
                // 로컬 삭제 로직
                deleteDiaryLocally(date);
                alertMessage('일기가 성공적으로 삭제되었습니다!', 'success');
                clearDiaryForm();
                renderDiaryList(); // 목록 업데이트
                // 서버 삭제 (개념적)
                // deleteDiaryFromServer(date);
            }
        });

        // 검색 버튼 클릭 이벤트
        searchButton.addEventListener('click', () => {
            const query = searchQueryInput.value.toLowerCase();
            searchDiaries(query);
        });

        // 백업 버튼 클릭 이벤트
        backupButton.addEventListener('click', async () => {
            const startDateStr = backupStartDateInput.value;
            const endDateStr = backupEndDateInput.value;

            if (!startDateStr || !endDateStr) {
                alertMessage('백업 기간을 선택해주세요!', 'warning');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            // 종료 날짜의 시간을 23:59:59로 설정하여 해당 날짜의 모든 일기를 포함하도록 함
            endDate.setHours(23, 59, 59, 999); 

            if (startDate > endDate) {
                alertMessage('시작 날짜는 종료 날짜보다 빠르거나 같아야 합니다!', 'warning');
                return;
            }

            let backupContent = `=== 일기 백업 (${startDateStr} ~ ${endDateStr}) ===\n\n`;
            let hasEntries = false;

            // localStorage의 모든 키를 순회하며 일기 데이터 추출
            const diaryKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('diary_')) {
                    diaryKeys.push(key);
                }
            }

            // 날짜 순으로 정렬
            diaryKeys.sort((a, b) => {
                const dateA = new Date(a.replace('diary_', ''));
                const dateB = new Date(b.replace('diary_', ''));
                return dateA - dateB;
            });

            diaryKeys.forEach(key => {
                const dateStr = key.replace('diary_', '');
                const entryDate = new Date(dateStr);

                // 선택된 기간 내의 일기만 포함
                if (entryDate >= startDate && entryDate <= endDate) {
                    const entry = loadDiaryLocally(dateStr);
                    if (entry) {
                        hasEntries = true;
                        backupContent += `--- 날짜: ${dateStr} ---\n`;
                        backupContent += `기분: ${entry.emotion || '없음'}\n`;
                        backupContent += `태그: ${entry.tags && entry.tags.length > 0 ? entry.tags.join(', ') : '없음'}\n`;
                        backupContent += `내용:\n${entry.content}\n`;
                        if (entry.imageData && entry.imageData.length > 0) {
                            backupContent += `(사진 ${entry.imageData.length}장 첨부됨 - 텍스트 파일에는 이미지 포함 안됨)\n`;
                        }
                        backupContent += `저장 시각: ${new Date(entry.timestamp).toLocaleString()}\n\n`;
                    }
                }
            });

            if (!hasEntries) {
                alertMessage('선택된 기간에 작성된 일기가 없습니다.', 'info');
                return;
            }

            // 텍스트 파일로 저장
            const blob = new Blob([backupContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diary_backup_${startDateStr}_${endDateStr}.txt`;
            document.body.appendChild(a);
            a.click(); // 다운로드 트리거
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // URL 해제

            alertMessage('일기 백업이 완료되었습니다!', 'success');
        });


        /* --- 일기 저장/불러오기/삭제 로직 (로컬 저장소) --- */

        // 로컬 저장: 브라우저의 localStorage를 활용
        function saveDiaryLocally(date, entry) {
            localStorage.setItem(`diary_${date}`, JSON.stringify(entry));
        }

        // 로컬 불러오기: localStorage에서 일기 내용 불러오기
        function loadDiaryLocally(date) {
            const storedEntry = localStorage.getItem(`diary_${date}`);
            return storedEntry ? JSON.parse(storedEntry) : null;
        }

        // 로컬 삭제: localStorage에서 일기 내용 삭제
        function deleteDiaryLocally(date) {
            localStorage.removeItem(`diary_${date}`);
        }

        // 특정 날짜의 일기 불러와 UI에 표시
        function loadDiary(date) {
            const entry = loadDiaryLocally(date);
            if (entry) {
                diaryContentTextarea.value = entry.content;
                // 감정 및 태그 UI 업데이트
                emotionOptions.forEach(option => option.classList.remove('selected'));
                if (entry.emotion) {
                    const emotionOpt = document.querySelector(`.emotion-tags .option[data-value="${entry.emotion}"]`);
                    if (emotionOpt) emotionOpt.classList.add('selected');
                    selectedEmotionInput.value = entry.emotion;
                } else {
                    selectedEmotionInput.value = '';
                }
                if (entry.tags && Array.isArray(entry.tags)) {
                    entry.tags.forEach(tag => {
                        const tagOpt = document.querySelector(`.emotion-tags .option[data-value="${tag}"]`);
                        if (tagOpt) tagOpt.classList.add('selected');
                    });
                    selectedTagsInput.value = JSON.stringify(entry.tags);
                } else {
                    selectedTagsInput.value = '[]';
                }

                // 여러 이미지 미리보기 업데이트
                imagePreviewsContainer.innerHTML = ''; // 기존 미리보기 초기화
                if (entry.imageData && Array.isArray(entry.imageData) && entry.imageData.length > 0) {
                    entry.imageData.forEach(imgSrc => {
                        createImagePreview(imgSrc); // 이미지 미리보기 생성 함수 호출
                    });
                }
            } else {
                clearDiaryForm();
            }
        }

        // 일기 작성 폼 초기화
        function clearDiaryForm() {
            diaryContentTextarea.value = '';
            emotionOptions.forEach(option => option.classList.remove('selected'));
            selectedEmotionInput.value = '';
            selectedTagsInput.value = '[]';
            imagePreviewsContainer.innerHTML = ''; // 여러 이미지 미리보기 컨테이너 초기화
            photoUploadInput.value = ''; // 파일 입력 초기화
            // 날짜는 오늘 날짜로 유지 (사용자가 다른 날짜를 선택하지 않는 한)
            // const today = new Date();
            // const year = today.getFullYear();
            // const month = String(today.getMonth() + 1).padStart(2, '0');
            // const day = String(today.getDate()).padStart(2, '0');
            // const todayString = `${year}-${month}-${day}`;
            // diaryDateInput.value = todayString;
        }

        // 일기 목록 렌더링
        function renderDiaryList() {
            diaryListUl.innerHTML = ''; // 기존 목록 초기화
            const diaryDates = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('diary_')) {
                    diaryDates.push(key.replace('diary_', ''));
                }
            }
            diaryDates.sort((a, b) => new Date(b) - new Date(a)); // 최신 날짜부터 정렬

            if (diaryDates.length === 0) {
                const li = document.createElement('li');
                li.textContent = '아직 작성된 일기가 없어요.';
                diaryListUl.appendChild(li);
                return;
            }

            diaryDates.forEach(date => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${date}</span>
                                <button data-date="${date}">열기</button>`;
                li.querySelector('button').addEventListener('click', (event) => {
                    const targetDate = event.target.dataset.date;
                    diaryDateInput.value = targetDate; // 날짜 입력란 업데이트
                    loadDiary(targetDate);
                });
                diaryListUl.appendChild(li);
            });
        }

        // 텍스트 기반 검색 기능
        function searchDiaries(query) {
            searchResultsDiv.innerHTML = ''; // 기존 검색 결과 초기화
            if (!query) {
                searchResultsDiv.textContent = '검색어를 입력해주세요.';
                return;
            }

            let foundResults = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('diary_')) {
                    const date = key.replace('diary_', '');
                    const entry = loadDiaryLocally(date);
                    if (entry && entry.content.toLowerCase().includes(query)) {
                        const resultDiv = document.createElement('div');
                        resultDiv.innerHTML = `<strong>${date}</strong>: ${entry.content.substring(0, Math.min(entry.content.length, 100))}...`; // 100자까지 표시
                        resultDiv.addEventListener('click', () => {
                            diaryDateInput.value = date;
                            loadDiary(date);
                            searchResultsDiv.innerHTML = ''; // 검색 결과 닫기
                            searchQueryInput.value = '';
                        });
                        searchResultsDiv.appendChild(resultDiv);
                        foundResults = true;
                    }
                }
            }

            if (!foundResults) {
                searchResultsDiv.textContent = '검색 결과가 없습니다.';
            }
        }

        /* --- 서버 저장 (개념적) 로직 스켈레톤 --- */
        // 실제 서버 구현은 제외하고, fetch API를 사용한 비동기 통신 예시만 주석으로 명시합니다.

        /**
         * @param {string} date - 일기 날짜 (YYYY-MM-DD)
         * @param {object} entry - 일기 내용 객체
         */
        async function saveDiaryToServer(date, entry) {
            console.log('서버에 일기 저장 시도:', date, entry);
            try {
                // 실제 서버 엔드포인트와 데이터 형식에 맞게 수정해야 합니다.
                const response = await fetch('/api/diary/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date: date, data: entry }),
                });
                if (response.ok) {
                    console.log('서버에 일기 저장 성공!');
                    // alertMessage('서버에 일기 저장 성공!', 'success');
                } else {
                    console.error('서버에 일기 저장 실패:', response.statusText);
                    // alertMessage('서버에 일기 저장 실패!', 'error');
                }
            } catch (error) {
                console.error('서버 통신 오류:', error);
                // alertMessage('서버 통신 오류 발생!', 'error');
            }
        }

        /**
         * @param {string} date - 일기 날짜 (YYYY-MM-DD)
         * @returns {Promise<object|null>} - 일기 내용 객체 또는 null
         */
        async function loadDiaryFromServer(date) {
            console.log('서버에서 일기 불러오기 시도:', date);
            try {
                const response = await fetch(`/api/diary/load?date=${date}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('서버에서 일기 불러오기 성공:', data);
                    return data; // 불러온 일기 데이터 반환
                } else {
                    console.error('서버에서 일기 불러오기 실패:', response.statusText);
                    return null;
                }
            } catch (error) {
                console.error('서버 통신 오류:', error);
                return null;
            }
        }

        /**
         * @param {string} date - 일기 날짜 (YYYY-MM-DD)
         */
        async function deleteDiaryFromServer(date) {
            console.log('서버에서 일기 삭제 시도:', date);
            try {
                const response = await fetch(`/api/diary/delete?date=${date}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    console.log('서버에서 일기 삭제 성공!');
                    // alertMessage('서버에서 일기 삭제 성공!', 'success');
                } else {
                    console.error('서버에서 일기 삭제 실패:', response.statusText);
                    // alertMessage('서버에서 일기 삭제 실패!', 'error');
                }
            } catch (error) {
                console.error('서버 통신 오류:', error);
                // alertMessage('서버 통신 오류 발생!', 'error');
            }
        }

        /* --- 커스텀 경고/확인 메시지 (alert/confirm 대체) --- */
        // alert()와 confirm() 대신 사용할 커스텀 메시지 박스
        function alertMessage(message, type = 'info') {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) existingAlert.remove();

            const alertBox = document.createElement('div');
            alertBox.id = 'customAlert';
            alertBox.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                color: white;
                opacity: 0;
                transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            `;

            if (type === 'success') {
                alertBox.style.backgroundColor = '#a8d5ba'; /* 민트색 */
            } else if (type === 'error') {
                alertBox.style.backgroundColor = '#ff7f7f'; /* 빨강색 */
            } else if (type === 'warning') {
                alertBox.style.backgroundColor = '#ffbe76'; /* 주황색 */
            } else {
                alertBox.style.backgroundColor = '#76baff'; /* 파랑색 (info) */
            }

            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.style.opacity = '1';
                alertBox.style.transform = 'translateX(-50%) translateY(0)';
            }, 50);

            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.transform = 'translateX(-50%) translateY(-20px)';
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        function confirmMessage(message) {
            // Canvas 환경에서 confirm()이 작동하지 않으므로, 커스텀 모달로 대체합니다.
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1001;
                `;
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); color: #5a4a42;">
                        <p style="margin-bottom: 20px; font-size: 1.1em; font-weight: 600;">${message}</p>
                        <button id="confirmYes" style="margin-right: 10px; padding: 10px 20px; background-color: #a8d5ba; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">예</button>
                        <button id="confirmNo" style="padding: 10px 20px; background-color: #ff7f7f; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">아니오</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('confirmYes').onclick = () => { modal.remove(); resolve(true); };
                document.getElementById('confirmNo').onclick = () => { modal.remove(); resolve(false); };
            });
        }

    </script>
</body>
</html>
